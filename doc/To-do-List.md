# 算法详述
## 灯条检测
这一部分沿用了大疆开源的代码，核心思想就是灯条中心的亮度很高，但是颜色分量不足。颜色分量主要集中于灯条的周围。所以需要综合 color 和 light 两个方面做检测。一些细节的地方：
1. 形态学: 膨胀 or 开运算 (对快递移动的情况可能有影响，装甲识别有很多经验参数是一帧一帧调出来的)
   ```c++
    // src/detect_factory/armor_detect.cpp：line 165
  	cv::dilate(binary_color_img, binary_color_img, element, cv::Point(-1, -1), 1);
  	binary_light_img = binary_color_img & binary_brightness_img;
   ```
2. 筛选lights: 这里的主要目的是把灯柱血条等错误的识别筛掉，但是移动过程中，装甲板会有很严重的拖影，按照最理想的情况进行筛选，镜头一旦晃动可能就啥都看不到了。（我们用的<200RMB的摄像头跟工业相机确实无法比）
## Filterlights
1. adjustrect 调整灯条的角度和与长宽
2. 针对高速移动带有拖影的灯条进行筛选
3. 针对灯条细小的情况,较为理想进行筛选。包括：
   - 根据灯条的数值角度
   - 根据灯条自身的纵横比例
   - 根据灯条的最大面积和最小面积
## 匹配lights
- 左右灯条的角度数值差(这里我们很不嫌麻烦地去掉了灯条与竖直方向的角度的绝对值，这样灯条偏左偏右就可以鉴别，缺点是代码太长)
- 左右灯条的高度差与宽度差
- 矩形armor的长宽比例, 这一数值需要根据灯条的角度差来进行调整, 因为俯仰角会影响比例
- 包围矩形要取 max_height 与 min_width 可以更好固定比例,
- 矩形armor的平行角度与左右灯条的角度绝对值积累差[这是一个很有用的标准]

针对镜头移动的拖影，我们又考虑了很多情况
1. 装甲板快速移动,两灯条平行
2. 同上,其中一块略有倾斜
3. 针对中速拖影进行处理, 平行, 90度平行, 带有误差的平行[待补充]
4. 灯条几乎同侧的匹配
5. 灯条不同侧的误差匹配
6. 其他边界情况

检测装甲板的移动速度对后面的预测等工作都很有帮助。参见：
```c++
include/detect_factory/armor_info.hpp：line 92
enum Armor_Twist { STILL = 1, LOW_MOVE = 2, MID_MOVE = 3, FAST_MOVE = 4 }; // 速度信息
```
## 筛选armor
- 进行一次去重操作
- 对大面积装甲板计算mean与stddev确定armor[待优化]
- 对小面积装甲板不计算
- 针对不同速度移动下的装甲板分类讨论mean与sttdev
- SVM

## 确定要击打的装甲板
- 根据 armor.size.area() 与 armor.angle 判断[待优化]
- 根据速度信息筛选一下
- 
- 6
- [待优化1]灯柱的pointPolygonTest可以由中心点代替,或寻求其他方法(已解决)
- [待优化2]需要更丰富的场景来确定宽泛的阈值
- [待优化3]需要更丰富的场景来确定宽泛的阈值
- [待优化4]需要区分大小装甲板(除了比例,更重要的是svm)
- [待优化4]需要区分工程装甲板与步兵装甲板
- [待优化4]后期可以考虑使用图像矩, svm 等等
- [待优化5]增加armor的dxdy信息, 云台坐标需要和串口数据相融合, 底盘坐标则不需要
- 7
- [detail补充]
- armor_info...{dxdy}
- 单装甲和多装甲的自由识别 
- 大\小装甲板区分识别
- 要考虑加领域搜索的vector....
- 连续搜索_cnt = 5 
- lost_cnt = 3        [ok]
- 摄像头要加std::thread [ok]

- 8
- [Filterarmor]
- 根据mean与stddev
- 根据灰度直方图的匹配度
- svm(最准确)  100x25   60x25

[连续识别3次才发serial] 暂不加入, 这会导致发送率极其低下

[armor判断] 大小装甲板 (已经取消)

[armor_history].size() = 5

[考虑邻域搜索]

[提前角度解算,距离信息可以做决策]
[armor移动速度 可以做决策]
[armor的角度,面积,大小]

对同一块装甲板要作出预测, 融合两帧之间的信息, 融合速度, 考虑时间, 解决结果跳变 与 错误预测

Next:
下一步, 加入距离判断,优化choose信息
目前只有angle_dis判断,不够鲁棒


# 需要完善的

- filerarmor当中svm和其他一些标准需要更改优先级
- armorrecoder需要再次优化